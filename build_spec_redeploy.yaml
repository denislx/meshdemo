version: 0.1             
component: build
timeoutInSeconds: 5000
shell: bash
env:
  exportedVariables:
    - version
steps:
  - type: Command
    command: | 
      echo "Version: ${version}"
  - type: Command
    command: | 
      oci ce cluster create-kubeconfig --cluster-id ocid1.cluster.oc1.eu-amsterdam-1.aaaaaaaasljp3fqfq5pt32nnic5qs4njo45dmtaanwq2ccxnyckxcyljtn7q --file kconfig --region eu-amsterdam-1 --token-version 2.0.0  --kube-endpoint PUBLIC_ENDPOINT
  - type: Command
    command: |
      chmod +x ./kubectl
      export KUBECONFIG="kconfig"
      export meshdemo_version=meshdemo-125
      export home_v1_version=ujyt6a
      export home_v2_version=4smoja
      export price_v1_version=version
      if [ -n "${meshdemo_version}" ]; then
          sed -i "s/tag_home_v1/${home_v1_version}/g" app.yaml
          sed -i "s/tag_home_v2/${home_v2_version}/g" app.yaml
          sed -i "s/tag_price_v1/${price_v1_version}/g" app.yaml
          sed -i "s/meshdemo_version/${meshdemo_version}/g" app.yaml
          ./kubectl delete deployment home-v1 -n $meshdemo_version
          ./kubectl delete deployment home-v2 -n $meshdemo_version
          ./kubectl delete deployment price-v1 -n $meshdemo_version
          ./kubectl create -f app.yaml &
      fi